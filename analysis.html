<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Text Aggregation & Cognitive Analysis</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body class="bg-gray-100 min-h-screen flex items-center justify-center">
  <div class="max-w-4xl w-full bg-white p-10 rounded-xl shadow-lg">
    <h1 class="text-3xl font-bold text-center mb-4">Text Aggregation & Analysis</h1>
    <p id="iteration-display" class="text-blue-600 text-center font-semibold mb-6">
      Loading active iteration...
    </p>

    <div class="space-y-6">
      <!-- Aggregated text area -->
      <div>
        <label for="aggregated-text" class="block text-gray-700 font-medium mb-2">
          Aggregated Descriptions
        </label>
        <textarea
          id="aggregated-text"
          rows="10"
          class="w-full p-3 border rounded-lg font-mono text-sm bg-gray-50 focus:ring focus:ring-blue-200"
          placeholder="Click 'Aggregate Descriptions' to load text from the database..."
        ></textarea>
      </div>

      <!-- Summary text area -->
      <div>
        <label for="summary-text" class="block text-gray-700 font-medium mb-2">
          Cognitive Analysis (Gemini)
        </label>
        <textarea
          id="summary-text"
          rows="10"
          readonly
          class="w-full p-3 border rounded-lg font-mono text-sm bg-gray-50 focus:ring focus:ring-purple-200"
          placeholder="Analysis result will appear here..."
        ></textarea>
      </div>
    </div>

    <div class="flex justify-between mt-6">
      <button id="aggregate-btn" class="bg-blue-500 text-white px-6 py-2 rounded hover:bg-blue-600">
        Aggregate Descriptions
      </button>
      <button id="analyze-btn" class="bg-purple-500 text-white px-6 py-2 rounded hover:bg-purple-600">
        Analyze Text
      </button>
      <button id="clear-btn" class="bg-gray-400 text-white px-6 py-2 rounded hover:bg-gray-500">
        Clear
      </button>
    </div>

    <p id="syscheck" class="text-xs text-gray-500 text-center mt-6"></p>
  </div>

  <script>
    const SUPABASE_URL = "https://dtfecbqteajwtcmqudpd.supabase.co";
    const SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR0ZmVjYnF0ZWFqd3RjbXF1ZHBkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg3Mjc0MzksImV4cCI6MjA3NDMwMzQzOX0.tY8R92LdJuGMDI3kVA2nN3ALugSRP3LJKCMBuVm7vRY";
    const GEMINI_PROXY_URL = "https://dtfecbqteajwtcmqudpd.functions.supabase.co/gemini-proxy";

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const syscheck = document.getElementById("syscheck");

    // --- Quick connection test ---
    async function checkConnections() {
      try {
        const { error } = await supabase.from("iterations").select("id").limit(1);
        if (error) throw error;

        const geminiResp = await fetch(GEMINI_PROXY_URL, { method: "OPTIONS" });
        if (!geminiResp.ok) throw new Error("Gemini not reachable");

        syscheck.textContent = "✅ Supabase & Gemini proxy online";
        syscheck.classList.remove("text-gray-500", "text-red-600");
        syscheck.classList.add("text-green-600");
      } catch (e) {
        syscheck.textContent = "⚠️ Connection check failed: " + e.message;
        syscheck.classList.remove("text-gray-500", "text-green-600");
        syscheck.classList.add("text-red-600");
      }
    }

    document.addEventListener("DOMContentLoaded", async () => {
      console.log("🟢 analysis.html: init start");

      const iterationDisplay = document.getElementById("iteration-display");
      const aggregateBtn = document.getElementById("aggregate-btn");
      const analyzeBtn = document.getElementById("analyze-btn");
      const clearBtn = document.getElementById("clear-btn");
      const aggregatedText = document.getElementById("aggregated-text");
      const summaryText = document.getElementById("summary-text");

      checkConnections(); // Run connection check immediately

      // --- Load active iteration ---
      try {
        console.log("→ querying Supabase for active iteration...");
        const { data, error } = await supabase
          .from("iterations")
          .select("*")
          .is("end_date", null)
          .single();

        if (error || !data) throw error || new Error("No active iteration found");
        iterationDisplay.textContent = `Active Iteration: ${data.name} (ID: ${data.id})`;
        console.log("✅ Active iteration:", data);
      } catch (err) {
        console.error("❌ Failed to load iteration:", err.message);
        iterationDisplay.textContent = "Error loading iteration.";
        iterationDisplay.classList.replace("text-blue-600", "text-red-600");
      }

      // --- Aggregate all role descriptions ---
      aggregateBtn.addEventListener("click", async () => {
        console.log("→ fetching all role descriptions from Supabase...");
        aggregatedText.value = "Loading all descriptions...";
        summaryText.value = "";

        try {
          const { data: roles, error } = await supabase
            .from("person_roles")
            .select("description")
            .not("description", "is", null);

          if (error || !roles || roles.length === 0)
            throw new Error("No descriptions found.");

          const allText = roles.map((r) => r.description).join("\n\n");
          aggregatedText.value = allText;
          console.log(`✅ Loaded ${roles.length} descriptions.`);
        } catch (err) {
          console.error("❌ Aggregate error:", err.message);
          aggregatedText.value = "Failed to load descriptions.";
        }
      });

      // --- Analyze text using Gemini via Supabase Function ---
      analyzeBtn.addEventListener("click", async () => {
        const text = aggregatedText.value.trim();
        if (!text) {
          alert("Please load or enter text before analyzing.");
          return;
        }

        summaryText.value = "Analyzing with Gemini (Supabase)... please wait.";
        try {
          console.log("→ sending text to Supabase Gemini proxy...");
          const response = await fetch(GEMINI_PROXY_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ text }),
          });

          const result = await response.json();
          console.log("✅ Gemini response:", result);

          const aiText =
            result?.candidates?.[0]?.content?.parts?.[0]?.text ||
            JSON.stringify(result, null, 2);

          summaryText.value = aiText;
        } catch (err) {
          console.error("❌ Gemini error:", err);
          summaryText.value = "Error analyzing text.";
        }
      });

      // --- Clear both textareas ---
      clearBtn.addEventListener("click", () => {
        aggregatedText.value = "";
        summaryText.value = "";
      });
    });
  </script>
</body>
</html>

