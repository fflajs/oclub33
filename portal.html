<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Application Portal</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body class="bg-gray-100 flex flex-col items-center justify-center min-h-screen">
  <div class="text-center bg-white p-12 rounded-lg shadow-lg">
    <h1 id="welcome-message" class="text-4xl font-bold mb-2">Welcome!</h1>
    <p id="iteration-display" class="text-blue-600 font-semibold mb-8">
      Loading active iteration...
    </p>
    <p class="text-gray-600 mb-8">Please select an application to continue.</p>

    <div class="space-y-4">
      <a
        href="login.html"
        class="block w-full bg-blue-500 text-white font-bold py-4 px-8 rounded-lg hover:bg-blue-600 transition-colors duration-200"
      >
        Login to Cognitive Visualizer
      </a>
      <a
        href="analysis.html"
        class="block w-full bg-purple-500 text-white font-bold py-4 px-8 rounded-lg hover:bg-purple-600 transition-colors duration-200 mt-4"
      >
        Analyze Descriptions
      </a>
    </div>

    <a
      href="index.html"
      class="inline-block align-baseline font-bold text-sm text-blue-500 hover:text-blue-800 mt-6"
    >
      Logout
    </a>
  </div>

  <p id="syscheck" class="text-xs text-gray-500 mt-4 text-center"></p>

  <script>
    console.log("üü¢ portal.html: script start");

    // --- Supabase + Gemini setup ---
    const SUPABASE_URL = "https://dtfecbqteajwtcmqudpd.supabase.co";
    const SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR0ZmVjYnF0ZWFqd3RjbXF1ZHBkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg3Mjc0MzksImV4cCI6MjA3NDMwMzQzOX0.tY8R92LdJuGMDI3kVA2nN3ALugSRP3LJKCMBuVm7vRY";
    const GEMINI_PROXY_URL = "https://dtfecbqteajwtcmqudpd.functions.supabase.co/gemini-proxy";

    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    console.log("‚úÖ Supabase client initialized:", sb ? "ok" : "failed");

    // --- Connection check ---
    const syscheck = document.getElementById("syscheck");
    async function checkConnections() {
      try {
        const { error } = await sb.from("iterations").select("id").limit(1);
        if (error) throw error;
        const geminiResp = await fetch(GEMINI_PROXY_URL, { method: "OPTIONS" });
        if (!geminiResp.ok) throw new Error("Gemini not reachable");
        syscheck.textContent = "‚úÖ Supabase & Gemini proxy online";
      } catch (e) {
        syscheck.textContent = "‚ö†Ô∏è Connection check failed: " + e.message;
      }
    }
    checkConnections();

    document.addEventListener("DOMContentLoaded", async () => {
      console.log("‚Üí DOMContentLoaded fired");

      const welcomeEl = document.getElementById("welcome-message");
      const iterationEl = document.getElementById("iteration-display");

      const userName = sessionStorage.getItem("loggedInUser");
      console.log("‚Üí sessionStorage.loggedInUser =", userName);

      if (userName) {
        welcomeEl.textContent = `Welcome, ${userName}!`;
      } else {
        console.warn("‚ö†Ô∏è No loggedInUser found in sessionStorage ‚Üí redirecting...");
        window.location.href = "index.html";
        return;
      }

      // --- Load Active Iteration ---
      iterationEl.textContent = "Connecting to Supabase...";
      try {
        const { data, error } = await sb
          .from("iterations")
          .select("id, name, start_date, end_date")
          .is("end_date", null)
          .limit(1)
          .single();

        if (error) {
          iterationEl.textContent = "Error: " + error.message;
          iterationEl.classList.add("text-red-600");
          console.error("‚ùå Supabase error:", error);
          return;
        }

        if (!data) {
          iterationEl.textContent = "No active iteration found.";
          return;
        }

        const formattedDate = new Date(data.start_date).toLocaleDateString("en-GB");
        iterationEl.textContent = `Active Iteration: ${data.name} (since ${formattedDate})`;
      } catch (err) {
        iterationEl.textContent = "Error loading iteration: " + err.message;
        iterationEl.classList.add("text-red-600");
        console.error("üí• Exception:", err);
      }

      console.log("üü¢ portal.html: init complete");
    });
  </script>
</body>
</html>

