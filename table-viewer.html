<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Table Viewer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body class="bg-gray-100 min-h-screen">
  <div class="max-w-6xl mx-auto py-10">
    <h1 class="text-3xl font-bold text-center mb-8 text-gray-800">Database Table Viewer</h1>
    <div id="tables-container" class="space-y-6"></div>
    <div class="text-center mt-8">
      <a href="/admin.html" class="text-blue-600 hover:text-blue-800 font-semibold">‚Üê Back to Admin Portal</a>
    </div>
  </div>

  <script>
    console.log("üü¢ table-viewer.html: script start");

    const SUPABASE_URL = "https://dtfecbqteajwtcmqudpd.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR0ZmVjYnF0ZWFqd3RjbXF1ZHBkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg3Mjc0MzksImV4cCI6MjA3NDMwMzQzOX0.tY8R92LdJuGMDI3kVA2nN3ALugSRP3LJKCMBuVm7vRY";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    console.log("‚úÖ Supabase client initialized");

    const tableList = [
      { name: "iterations", label: "Iterations" },
      { name: "organization_units", label: "Organization Units" },
      { name: "people", label: "People" },
      { name: "person_roles", label: "Person Roles" },
      { name: "app_data", label: "App Data" },
      { name: "surveys", label: "Surveys" }
    ];

    async function loadAllTables() {
      const container = document.getElementById("tables-container");
      container.innerHTML = "";
      console.log("‚Üí Loading all tables...");

      for (const tbl of tableList) {
        console.log(`‚Üí Querying table: ${tbl.name}`);
        const { data, error } = await supabase.from(tbl.name).select("*");
        if (error) {
          console.error(`‚ùå Error loading ${tbl.name}:`, error);
          container.innerHTML += `<div class="bg-red-100 border border-red-300 p-4 rounded"><h2 class="font-bold text-red-700">${tbl.label}</h2><p class="text-red-600">Error loading data: ${error.message}</p></div>`;
          continue;
        }

        console.log(`‚úÖ ${tbl.name}: ${data.length} rows`);
        if (!data || data.length === 0) {
          container.innerHTML += `<div class="bg-white p-6 rounded-lg shadow"><h2 class="text-xl font-bold mb-2 text-gray-800">${tbl.label}</h2><p class="text-gray-500">No records found.</p></div>`;
          continue;
        }

        const headers = Object.keys(data[0]);
        const tableHTML = `
          <div class="bg-white p-6 rounded-lg shadow">
            <button onclick="toggleTable('${tbl.name}')" class="w-full text-left focus:outline-none">
              <h2 class="text-xl font-bold mb-3 text-gray-800 flex justify-between items-center">
                ${tbl.label}
                <span id="arrow-${tbl.name}" class="transition-transform">‚ñº</span>
              </h2>
            </button>
            <div id="table-${tbl.name}">
              <div class="overflow-x-auto border rounded">
                <table class="min-w-full border-collapse">
                  <thead class="bg-gray-200 text-gray-700">
                    <tr>
                      ${headers.map(h => `<th class="px-3 py-2 border text-left">${h}</th>`).join("")}
                    </tr>
                  </thead>
                  <tbody>
                    ${data.map(row => `
                      <tr class="border-t hover:bg-gray-50">
                        ${headers.map(h => `<td class="px-3 py-2 border text-sm text-gray-700">${row[h] ?? ""}</td>`).join("")}
                      </tr>`).join("")}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        `;
        container.innerHTML += tableHTML;
      }

      console.log("‚úÖ All tables loaded and rendered");
    }

    function toggleTable(tableName) {
      const div = document.getElementById(`table-${tableName}`);
      const arrow = document.getElementById(`arrow-${tableName}`);
      if (div.style.display === "none") {
        div.style.display = "block";
        arrow.textContent = "‚ñº";
      } else {
        div.style.display = "none";
        arrow.textContent = "‚ñ∂";
      }
    }

    document.addEventListener("DOMContentLoaded", loadAllTables);
  </script>
</body>
</html>

