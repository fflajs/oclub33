<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Organization Chart Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .tree ul { padding-left: 20px; position: relative; }
        .tree li { list-style-type: none; margin: 10px 0; position: relative; }
        .tree li::before { content: ''; position: absolute; top: -5px; left: -20px; border-left: 1px solid #ccc; border-bottom: 1px solid #ccc; width: 20px; height: 1.1em; }
        .tree li:last-child::before { height: 1.2em; }
        .manager-icon { color: #facc15; }
        .modal { display: flex; }
    </style>
</head>
<body class="bg-gray-100 p-8">

    <div class="max-w-4xl mx-auto bg-white p-8 rounded-lg shadow-lg">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold">Organization Chart Manager</h1>
            <a href="/index.html" class="text-blue-500 hover:underline">&larr; Back to Main Menu</a>
        </div>
        <p class="text-gray-600 mb-6">Select a person and click "Launch Tool" to open the Cognitive Space Visualizer for that user.</p>

        <div class="mb-6">
            <h2 class="text-xl font-semibold mb-2">Add New Top-Level Unit</h2>
            <div class="flex">
                <input type="text" id="new-unit-name" class="flex-grow p-2 border rounded-l-md" placeholder="Enter new unit name...">
                <button id="add-top-level-button" class="bg-blue-500 text-white p-2 rounded-r-md hover:bg-blue-600">Add Unit</button>
            </div>
        </div>

        <div id="org-chart-container" class="tree"></div>
    </div>

    <div id="person-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center modal">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md">
            <h3 id="modal-title" class="text-xl font-bold mb-4"></h3>
            <input type="hidden" id="modal-person-id">
            <input type="hidden" id="modal-unit-id">
            <div class="space-y-4">
                <div>
                    <label for="modal-person-name" class="block text-sm font-medium text-gray-700">Person's Name</label>
                    <input type="text" id="modal-person-name" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="modal-is-manager" class="h-4 w-4 text-indigo-600 border-gray-300 rounded">
                    <label for="modal-is-manager" class="ml-2 block text-sm text-gray-900">Is Manager of this Unit?</label>
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="modal-cancel-button" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300">Cancel</button>
                <button id="modal-save-button" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">Save</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const chartContainer = document.getElementById('org-chart-container');
            const newUnitNameInput = document.getElementById('new-unit-name');
            const addTopLevelButton = document.getElementById('add-top-level-button');
            const baseUrl = window.location.origin;
            const personModal = document.getElementById('person-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalPersonIdInput = document.getElementById('modal-person-id');
            const modalUnitIdInput = document.getElementById('modal-unit-id');
            const modalPersonNameInput = document.getElementById('modal-person-name');
            const modalIsManagerCheckbox = document.getElementById('modal-is-manager');
            const modalSaveButton = document.getElementById('modal-save-button');
            const modalCancelButton = document.getElementById('modal-cancel-button');
            let units = [];
            let persons = [];

            async function apiRequest(endpoint, method = 'GET', body = null) {
                try {
                    const options = { method, headers: { 'Content-Type': 'application/json' } };
                    if (body) options.body = JSON.stringify(body);
                    const response = await fetch(`${baseUrl}${endpoint}`, options);
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
                    }
                    return response.status === 204 ? null : await response.json();
                } catch (error) {
                    alert(`An API error occurred: ${error.message}`);
                    console.error(`API Error on ${method} ${endpoint}:`, error);
                    throw error;
                }
            }
            
            function buildTree(currentUnits, currentPersons, parentId = null) {
                const children = currentUnits.filter(unit => unit.parent_id === parentId);
                if (children.length === 0) return '';
                let html = '<ul>';
                children.forEach(unit => {
                    const unitPersons = currentPersons.filter(p => p.org_unit_id === unit.id);
                    const manager = unitPersons.find(p => p.is_manager);
                    const coworkers = unitPersons.filter(p => !p.is_manager);
                    const sortedPersons = [manager, ...coworkers].filter(Boolean);
                    html += `
                        <li data-id="${unit.id}">
                            <span class="font-semibold text-lg">${unit.name}</span>
                            <div class="inline-block ml-4">
                                <a href="#" class="add-child text-green-600 hover:underline text-sm font-semibold" data-id="${unit.id}">+ Add Child Unit</a>
                                <a href="#" class="add-person text-purple-600 hover:underline text-sm font-semibold ml-2" data-id="${unit.id}" data-unit-name="${unit.name}">+ Add Person</a>
                                <a href="#" class="edit-unit text-blue-600 hover:underline text-sm font-semibold ml-2" data-id="${unit.id}" data-name="${unit.name}">Edit</a>
                                <a href="#" class="delete-unit text-red-600 hover:underline text-sm font-semibold ml-2" data-id="${unit.id}">Delete</a>
                            </div>`;
                    const renderPerson = (person, index) => {
                        const isManager = person.is_manager;
                        const roleText = isManager ? '(Manager)' : '';
                        const icon = isManager ? '<span class="manager-icon">â˜…</span>' : '';
                        const bgColor = index % 2 === 0 ? 'bg-gray-50' : 'bg-transparent';
                        return `
                            <div class="flex justify-between items-center py-1 px-2 rounded ${bgColor}">
                                <span class="font-medium">${icon} ${person.name} ${roleText}</span>
                                <div class="flex-shrink-0">
                                    <a href="/cognitive-tool.html?personId=${person.id}" class="launch-tool-btn bg-gray-200 text-gray-800 text-xs font-bold py-1 px-2 rounded-full hover:bg-gray-300 ml-4" data-id="${person.id}">Launch Tool</a>
                                    <a href="#" class="edit-person text-blue-500 text-xs ml-2" data-id="${person.id}">Edit</a>
                                    <a href="#" class="delete-person text-red-500 text-xs ml-2" data-id="${person.id}">Delete</a>
                                </div>
                            </div>`;
                    };
                    sortedPersons.forEach((person, index) => { html += renderPerson(person, index); });
                    html += buildTree(currentUnits, currentPersons, unit.id);
                    html += '</li>';
                });
                html += '</ul>';
                return html;
            }

            async function renderTree() {
                try {
                    const data = await apiRequest('/api/org-tree');
                    units = data.units;
                    persons = data.persons;
                    chartContainer.innerHTML = buildTree(units, persons);
                } catch (error) { chartContainer.innerHTML = `<p class="text-red-500">Could not render the organization tree.</p>`; }
            }

            function showPersonModal(config) {
                modalTitle.textContent = config.title;
                modalPersonIdInput.value = config.personId || '';
                modalUnitIdInput.value = config.unitId || '';
                modalPersonNameInput.value = config.name || '';
                modalIsManagerCheckbox.checked = config.isManager || false;
                personModal.classList.remove('hidden');
            }

            function hidePersonModal() {
                personModal.classList.add('hidden');
            }

            addTopLevelButton.addEventListener('click', async () => {
                const name = newUnitNameInput.value.trim();
                if (name) {
                    await apiRequest('/api/org-tree', 'POST', { name, parentId: null });
                    newUnitNameInput.value = '';
                    await renderTree();
                }
            });

            chartContainer.addEventListener('click', async (e) => {
                const target = e.target;
                const id = parseInt(target.dataset.id);

                if (target.classList.contains('launch-tool-btn')) {
                    e.preventDefault();
                    const person = persons.find(p => p.id === id);
                    if (person) {
                        const getOrgPath = (unitId) => {
                            let path = []; let currentUnit = units.find(u => u.id === unitId);
                            while(currentUnit) { path.unshift(currentUnit.name); currentUnit = units.find(u => u.id === currentUnit.parent_id); }
                            return path.join(' > ');
                        };
                        const orgPath = getOrgPath(person.org_unit_id);
                        const role = person.is_manager ? 'Manager' : 'Coworker';
                        
                        const url = new URL(target.href, window.location.origin);
                        url.searchParams.set('userName', person.name);
                        url.searchParams.set('userRole', role);
                        url.searchParams.set('userUnit', orgPath);
                        url.searchParams.set('userUnitId', person.org_unit_id);

                        const confirmationMessage = `You are about to launch the Cognitive Space Visualizer.\n\nAll actions will be performed as:\n\nUser: ${person.name}\nRole: ${role}\nUnit: ${orgPath}\n\nDo you want to continue?`;
                        if (confirm(confirmationMessage)) window.location.href = url.href;
                    }
                    return;
                }
                
                if (target.closest('a')) e.preventDefault();
                
                if (target.classList.contains('add-child')) {
                    const name = prompt('Enter name for the new child unit:');
                    if(name) await apiRequest('/api/org-tree', 'POST', { name, parentId: id });
                } else if (target.classList.contains('edit-unit')) {
                    const newName = prompt('Enter new name for the unit:', target.dataset.name);
                    if(newName) await apiRequest(`/api/org-tree/${id}`, 'PUT', { name: newName });
                } else if (target.classList.contains('delete-unit')) {
                    if (confirm('Are you sure you want to delete this unit and all its children/personnel?')) await apiRequest(`/api/org-tree/${id}`, 'DELETE');
                } else if (target.classList.contains('add-person')) {
                    showPersonModal({ title: `Add Person to "${target.dataset.unitName}"`, unitId: id });
                } else if (target.classList.contains('edit-person')) {
                    const person = persons.find(p => p.id === id);
                    if (person) showPersonModal({ title: `Edit Person: ${person.name}`, personId: person.id, name: person.name, isManager: person.is_manager });
                } else if (target.classList.contains('delete-person')) {
                    if (confirm('Are you sure you want to delete this person?')) await apiRequest(`/api/persons/${id}`, 'DELETE');
                }
                
                if(target.closest('a')) await renderTree();
            });

            modalSaveButton.addEventListener('click', async () => {
                const personId = parseInt(modalPersonIdInput.value);
                const unitId = parseInt(modalUnitIdInput.value);
                const name = modalPersonNameInput.value.trim();
                const isManager = modalIsManagerCheckbox.checked;
                if (!name) return alert('Person name cannot be empty.');

                if (personId) {
                    await apiRequest(`/api/persons/${personId}`, 'PUT', { name, isManager });
                } else {
                    await apiRequest('/api/persons', 'POST', { name, orgUnitId: unitId, isManager });
                }
                hidePersonModal();
                await renderTree();
            });
            
            modalCancelButton.addEventListener('click', hidePersonModal);
            personModal.addEventListener('click', (e) => { if (e.target === personModal) hidePersonModal(); });

            await renderTree();
        });
    </script>
</body>
</html>


