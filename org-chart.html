<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Organization Chart Manager</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { background-color: #f3f4f6; }
    .unit-line { border-left: 2px solid #d1d5db; margin-left: 20px; padding-left: 10px; }
    .person-line { display: flex; justify-content: space-between; align-items: center; margin-top: 4px; padding: 4px 8px; background: #f9fafb; border-radius: 6px; border: 1px solid #e5e7eb; }
    .link-action { color: #9333ea; cursor: pointer; font-weight: 500; margin-left: 4px; }
    .link-action:hover { text-decoration: underline; }
    .debug { font-size: 0.75rem; color: #6b7280; white-space: pre-line; }
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); justify-content: center; align-items: center; z-index: 50; }
    .modal-content { background: white; padding: 2rem; border-radius: 0.75rem; box-shadow: 0 10px 25px rgba(0,0,0,0.2); width: 22rem; text-align: left; }
    .modal.active { display: flex; }
  </style>
</head>

<body class="min-h-screen flex flex-col items-center py-6">
  <div class="bg-white rounded-xl shadow-lg p-8 w-full max-w-4xl">
    <div class="flex justify-between items-center mb-2">
      <h1 class="text-2xl font-bold text-gray-800">Organization Chart Manager</h1>
      <a href="admin.html" class="text-blue-600 hover:underline text-sm">‚Üê Back to Admin Portal</a>
    </div>
    <div id="iteration-display" class="text-center text-blue-700 mb-6 font-medium border border-blue-200 rounded-lg py-2 bg-blue-50">
      Loading active iteration...
    </div>

    <div class="flex flex-wrap justify-between items-center mb-6 space-y-3 md:space-y-0">
      <div class="flex space-x-2">
        <input id="new-unit-name" type="text" placeholder="Enter new unit name..."
          class="border border-gray-300 rounded px-3 py-2 w-64">
        <button id="add-unit" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Add Unit</button>
      </div>
      <div class="flex space-x-2">
        <input id="new-person-name" type="text" placeholder="Enter new person's full name..."
          class="border border-gray-300 rounded px-3 py-2 w-64">
        <button id="add-person" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">Create Person</button>
      </div>
    </div>

    <div id="org-tree" class="mt-4"></div>
    <div id="debug" class="debug mt-6 border-t border-gray-300 pt-4"></div>
    <p id="syscheck" class="text-xs text-gray-500 mt-4 text-center"></p>
  </div>

  <!-- Assign Person Modal -->
  <div id="assignModal" class="modal">
    <div class="modal-content">
      <h2 id="assignTitle" class="text-xl font-semibold mb-4">Assign Person</h2>
      <label for="personSelect" class="block text-sm font-medium text-gray-700 mb-1">Select Person</label>
      <select id="personSelect" class="border border-gray-300 rounded w-full p-2 mb-3">
        <option value="">Select a person...</option>
      </select>

      <label class="inline-flex items-center mb-4">
        <input id="isManager" type="checkbox" class="mr-2">
        <span>Is Manager of this Unit?</span>
      </label>

      <div class="flex justify-end space-x-2">
        <button id="cancelAssign" class="bg-gray-200 text-gray-700 px-4 py-2 rounded hover:bg-gray-300">Cancel</button>
        <button id="confirmAssign" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">Add Role</button>
      </div>
    </div>
  </div>

  <script>
    const SUPABASE_URL = "https://dtfecbqteajwtcmqudpd.supabase.co";
    const SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR0ZmVjYnF0ZWFqd3RjbXF1ZHBkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg3Mjc0MzksImV4cCI6MjA3NDMwMzQzOX0.tY8R92LdJuGMDI3kVA2nN3ALugSRP3LJKCMBuVm7vRY";
    const GEMINI_PROXY_URL = "https://dtfecbqteajwtcmqudpd.functions.supabase.co/gemini-proxy";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const syscheck = document.getElementById("syscheck");

    async function checkConnections() {
      try {
        const { error } = await supabase.from("iterations").select("id").limit(1);
        if (error) throw error;
        const geminiResp = await fetch(GEMINI_PROXY_URL, { method: "OPTIONS" });
        if (!geminiResp.ok) throw new Error("Gemini not reachable");
        syscheck.textContent = "‚úÖ Supabase & Gemini proxy online";
      } catch (e) {
        syscheck.textContent = "‚ö†Ô∏è Connection check failed: " + e.message;
      }
    }

    checkConnections();

    const dbg = (...a) => console.log("[org-chart]", ...a);

    document.addEventListener("DOMContentLoaded", async () => {
      dbg("üü¢ init start");
      const iterationDisplay = document.getElementById("iteration-display");
      const orgTree = document.getElementById("org-tree");
      const debugDiv = document.getElementById("debug");
      const log = (m) => (debugDiv.textContent += m + "\n");

      let activeIteration = null;

      // Modal refs
      const assignModal = document.getElementById("assignModal");
      const assignTitle = document.getElementById("assignTitle");
      const personSelect = document.getElementById("personSelect");
      const isManagerBox = document.getElementById("isManager");
      const cancelAssign = document.getElementById("cancelAssign");
      const confirmAssign = document.getElementById("confirmAssign");
      let currentUnitId = null;

      cancelAssign.onclick = () => assignModal.classList.remove("active");

      // --- Load Active Iteration ---
      try {
        const { data, error } = await supabase
          .from("iterations").select("*").is("end_date", null).single();
        if (error || !data) throw error || new Error("No active iteration");
        activeIteration = data;
        iterationDisplay.textContent = `Managing Organizational Chart for Active Iteration: ${data.name} (ID: ${data.id})`;
      } catch (e) {
        iterationDisplay.textContent = "Error loading active iteration.";
        iterationDisplay.classList.replace("text-blue-700", "text-red-600");
        return;
      }

      // --- Load & Render Chart ---
      async function loadOrgChart() {
        orgTree.innerHTML = "<p class='text-gray-500 text-center'>Loading organization data...</p>";
        const [unitsRes, rolesRes, peopleRes] = await Promise.all([
          supabase.from("organization_units").select("*").eq("iteration_id", activeIteration.id),
          supabase.from("person_roles").select("*").eq("iteration_id", activeIteration.id),
          supabase.from("people").select("*")
        ]);

        if (unitsRes.error || rolesRes.error || peopleRes.error) {
          dbg("‚ùå Data error", unitsRes.error, rolesRes.error, peopleRes.error);
          orgTree.innerHTML = "<p class='text-red-500 text-center'>Failed to load data.</p>";
          return;
        }

        const units = unitsRes.data, roles = rolesRes.data, people = peopleRes.data;
        dbg("‚úÖ Loaded", { units: units.length, roles: roles.length, people: people.length });

        orgTree.innerHTML = "";
        units.filter(u => u.parent_id === null).forEach(r => renderUnit(r, units, roles, people, orgTree));
      }

      function renderUnit(unit, allUnits, allRoles, allPeople, container) {
        const div = document.createElement("div");
        div.className = "mt-2";
        div.innerHTML = `
          <div class="font-bold text-lg text-gray-800">${unit.name}
            <span class="text-sm font-normal ml-2">
              <span class="link-action add-sub">+ Add Sub-Unit</span> ¬∑
              <span class="link-action assign-person">+ Assign Person</span> ¬∑
              <span class="link-action edit-unit text-blue-600">Edit</span> ¬∑
              <span class="link-action delete-unit text-red-600">Delete</span>
            </span>
          </div>
          <div id="people-${unit.id}" class="ml-4 mt-1"></div>
          <div id="subs-${unit.id}" class="unit-line mt-2"></div>
        `;
        container.appendChild(div);

        const peopleDiv = div.querySelector(`#people-${unit.id}`);
        const subDiv = div.querySelector(`#subs-${unit.id}`);

        // Render People linked via roles
        const unitRoles = allRoles.filter(r => r.org_unit_id === unit.id);
        unitRoles.forEach(r => {
          const p = allPeople.find(x => x.id === r.person_id);
          if (!p) return;
          const personEl = document.createElement("div");
          personEl.className = "person-line";
          const isManager = r.is_manager ? "‚òÖ " : "";
          const mgrTag = r.is_manager ? " (Manager)" : "";
          personEl.innerHTML = `
            <span>${isManager}${p.name}${mgrTag}</span>
            <div>
              <a href="cognitive-tool.html?personRoleId=${r.id}&iterationId=${r.iteration_id}&userUnitId=${unit.id}"
                 class="bg-gray-200 text-gray-800 px-3 py-1 rounded hover:bg-gray-300 text-sm">Launch Tool</a>
              <button class="bg-red-500 text-white px-3 py-1 rounded text-sm remove-person">Remove</button>
            </div>
          `;
          personEl.querySelector(".remove-person").onclick = async () => {
            if (!confirm("Remove this person-role?")) return;
            const { error } = await supabase.from("person_roles").delete().eq("id", r.id);
            if (error) dbg("‚ùå Remove role error", error.message);
            else loadOrgChart();
          };
          peopleDiv.appendChild(personEl);
        });

        // Subunits recursive
        allUnits.filter(u => u.parent_id === unit.id)
          .forEach(s => renderUnit(s, allUnits, allRoles, allPeople, subDiv));

        // Buttons
        div.querySelector(".add-sub").onclick = async () => {
          const name = prompt("Sub-Unit name:");
          if (!name) return;
          await supabase.from("organization_units").insert({
            name, parent_id: unit.id, iteration_id: activeIteration.id
          });
          loadOrgChart();
        };

        div.querySelector(".assign-person").onclick = async () => {
          currentUnitId = unit.id;
          assignTitle.textContent = `Assign Person to "${unit.name}"`;
          const { data: persons, error } = await supabase.from("people").select("*");
          if (error) return alert("Error loading people list");
          personSelect.innerHTML = '<option value="">Select a person...</option>';
          persons.forEach(p => {
            const opt = document.createElement("option");
            opt.value = p.id; opt.textContent = p.name;
            personSelect.appendChild(opt);
          });
          isManagerBox.checked = false;
          assignModal.classList.add("active");
        };

        div.querySelector(".edit-unit").onclick = async () => {
          const newName = prompt("New name:", unit.name);
          if (!newName) return;
          await supabase.from("organization_units").update({ name: newName }).eq("id", unit.id);
          loadOrgChart();
        };

        div.querySelector(".delete-unit").onclick = async () => {
          if (!confirm("Delete this unit and all subunits?")) return;
          await supabase.from("organization_units").delete().eq("id", unit.id);
          loadOrgChart();
        };
      }

      confirmAssign.onclick = async () => {
        const pid = personSelect.value;
        if (!pid) return alert("Select a person first!");
        const isManager = isManagerBox.checked;
        const { error } = await supabase.from("person_roles").insert({
          person_id: pid, org_unit_id: currentUnitId,
          iteration_id: activeIteration.id, is_manager: isManager
        });
        if (error) alert("Error assigning role: " + error.message);
        assignModal.classList.remove("active");
        loadOrgChart();
      };

      document.getElementById("add-unit").onclick = async () => {
        const name = document.getElementById("new-unit-name").value.trim();
        if (!name) return alert("Enter a unit name");
        await supabase.from("organization_units").insert({ name, iteration_id: activeIteration.id });
        loadOrgChart();
      };

      document.getElementById("add-person").onclick = async () => {
        const name = document.getElementById("new-person-name").value.trim();
        if (!name) return alert("Enter a person name");
        await supabase.from("people").insert({ name });
        loadOrgChart();
      };

      await loadOrgChart();
      dbg("üü¢ init complete");
    });
  </script>
</body>
</html>

