<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Iteration Manager</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { background:#f3f4f6; }
    .card { background:#fff; border-radius:12px; box-shadow: 0 10px 15px rgba(0,0,0,.05); border:1px solid #e5e7eb; }
    .badge { padding:.15rem .5rem; border-radius:999px; font-size:.75rem; font-weight:600; }
    .badge-active { background:#d1fae5; color:#065f46; }
    .badge-closed { background:#e5e7eb; color:#374151; }
    .btn { border-radius:.5rem; padding:.5rem .9rem; font-weight:600; }
    .btn-blue { background:#3b82f6; color:#fff; }
    .btn-blue:hover { background:#2563eb; }
    .btn-red { background:#ef4444; color:#fff; }
    .btn-red:hover { background:#dc2626; }
    .btn-green { background:#10b981; color:#fff; }
    .btn-green:hover { background:#059669; }
    .btn-gray { background:#6b7280; color:#fff; }
    .btn-gray:hover { background:#4b5563; }
    .table { width:100%; border-collapse:separate; border-spacing:0; }
    .table th { text-align:left; font-weight:700; color:#374151; background:#f9fafb; border-bottom:1px solid #e5e7eb; padding:.75rem; }
    .table td { padding:.75rem; border-bottom:1px solid #e5e7eb; color:#111827; }
  </style>
</head>
<body class="min-h-screen flex flex-col items-center py-6">

  <div class="card w-full max-w-5xl p-8">
    <div class="flex items-center justify-between">
      <h1 class="text-3xl font-bold text-gray-900">Iteration Manager</h1>
      <a href="admin.html" class="text-blue-600 hover:underline text-sm">← Back to Admin Portal</a>
    </div>

    <p class="text-gray-600 mt-4">
      Here you can manage application iterations. Closing the active iteration archives its org chart.
      You can then start the <b>Next</b> iteration, which copies the structure from the last closed one,
      or create a completely new, blank iteration.
    </p>

    <div id="active-info" class="mt-4 text-center text-blue-700 font-medium border border-blue-200 rounded-lg py-2 bg-blue-50">
      Loading active iteration...
    </div>

    <div class="mt-6 flex flex-wrap items-center gap-3">
      <input id="next-name" type="text" placeholder="New iteration name…" class="border border-gray-300 rounded px-3 py-2 w-64">
      <select id="next-qs" class="border border-gray-300 rounded px-3 py-2">
        <option value="Deep_Analysis_120.json">Deep Analysis 120</option>
        <option value="Normal_Analysis_60.json">Normal Analysis 60</option>
        <option value="Pulse_Check_12.json">Pulse Check 12</option>
      </select>
      <button id="create-next" class="btn btn-green">Create Next Iteration (Clone)</button>
      <button id="create-blank" class="btn btn-blue">Create Blank Iteration</button>
    </div>

    <div class="mt-8 overflow-x-auto">
      <table class="table">
        <thead>
          <tr>
            <th style="width:60px;">ID</th>
            <th>Name</th>
            <th style="width:180px;">Start Date</th>
            <th style="width:160px;">End Date</th>
            <th style="width:180px;">Question Set</th>
            <th style="width:90px;">Status</th>
            <th style="width:160px;">Action</th>
          </tr>
        </thead>
        <tbody id="iterations-body"></tbody>
      </table>
    </div>

    <p id="syscheck" class="text-xs text-gray-500 mt-4 text-center"></p>
  </div>

  <script>
    // --- Supabase + Gemini setup ---
    const SUPABASE_URL = "https://dtfecbqteajwtcmqudpd.supabase.co";
    const SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR0ZmVjYnF0ZWFqd3RjbXF1ZHBkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg3Mjc0MzksImV4cCI6MjA3NDMwMzQzOX0.tY8R92LdJuGMDI3kVA2nN3ALugSRP3LJKCMBuVm7vRY";
    const GEMINI_PROXY_URL = "https://dtfecbqteajwtcmqudpd.functions.supabase.co/gemini-proxy";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const syscheck = document.getElementById("syscheck");
    async function checkConnections() {
      try {
        const { error } = await supabase.from("iterations").select("id").limit(1);
        if (error) throw error;
        const geminiResp = await fetch(GEMINI_PROXY_URL, { method: "OPTIONS" });
        if (!geminiResp.ok) throw new Error("Gemini not reachable");
        syscheck.textContent = "✅ Supabase & Gemini proxy online";
      } catch (e) {
        syscheck.textContent = "⚠️ Connection check failed: " + e.message;
      }
    }
    checkConnections();

    // --- Helpers ---
    const log = (...a) => console.log("[iteration-manager]", ...a);
    const fmt = (iso) => {
      if (!iso) return "N/A";
      const d = new Date(iso);
      if (isNaN(d)) return "N/A";
      return d.toLocaleDateString() + ", " + d.toLocaleTimeString();
    };

    const activeInfo = document.getElementById("active-info");
    const tbody = document.getElementById("iterations-body");
    const btnCreateNext = document.getElementById("create-next");
    const btnCreateBlank = document.getElementById("create-blank");
    const inputNextName = document.getElementById("next-name");
    const selectNextQs = document.getElementById("next-qs");

    let iterations = [];

    document.addEventListener("DOMContentLoaded", async () => {
      log("init start");
      await refresh();
      log("init done");
    });

    async function refresh() {
      await loadIterations();
      renderIterations();
      updateActiveInfo();
    }

    async function loadIterations() {
      const { data, error } = await supabase
        .from("iterations")
        .select("id, name, start_date, end_date, question_set")
        .order("id", { ascending: true });
      if (error) { log("loadIterations error:", error.message); return; }
      iterations = data || [];
    }

    function updateActiveInfo() {
      const active = iterations.find(it => it.end_date === null);
      if (active)
        activeInfo.textContent = `Active Iteration: ${active.name} (ID: ${active.id})`;
      else
        activeInfo.textContent = `No active iteration. You can create the next one or a blank iteration.`;
    }

    function renderIterations() {
      tbody.innerHTML = "";
      iterations.forEach(it => {
        const tr = document.createElement("tr");
        const isActive = it.end_date === null;
        tr.innerHTML = `
          <td>${it.id}</td>
          <td>${it.name || ""}</td>
          <td>${fmt(it.start_date)}</td>
          <td>${it.end_date ? fmt(it.end_date) : "N/A"}</td>
          <td>${(it.question_set || "").replace(".json","").replace(/_/g," ")}</td>
          <td>
            <span class="badge ${isActive ? "badge-active" : "badge-closed"}">
              ${isActive ? "Active" : "Closed"}
            </span>
          </td>
          <td>
            ${isActive
              ? `<button class="btn btn-gray btn-close" data-id="${it.id}">Close</button>`
              : `<button class="btn btn-red btn-delete" data-id="${it.id}">Delete</button>`
            }
          </td>
        `;
        tbody.appendChild(tr);
      });

      tbody.querySelectorAll(".btn-close").forEach(b => {
        b.addEventListener("click", async (e) => {
          const id = Number(e.currentTarget.dataset.id);
          if (!confirm("Close the active iteration now?")) return;
          await closeIteration(id);
          await refresh();
        });
      });

      tbody.querySelectorAll(".btn-delete").forEach(b => {
        b.addEventListener("click", async (e) => {
          const id = Number(e.currentTarget.dataset.id);
          if (!confirm("Delete this iteration? This cannot be undone.")) return;
          await deleteIteration(id);
          await refresh();
        });
      });
    }

    async function closeIteration(id) {
      const { error } = await supabase
        .from("iterations")
        .update({ end_date: new Date().toISOString() })
        .eq("id", id);
      if (error) alert("Failed to close iteration: " + error.message);
    }

    async function deleteIteration(id) {
      const { error } = await supabase.from("iterations").delete().eq("id", id);
      if (error) alert("Failed to delete iteration: " + error.message);
    }

    btnCreateBlank.addEventListener("click", async () => {
      const active = iterations.find(it => it.end_date === null);
      if (active) return alert("Close the active iteration first.");
      const name = inputNextName.value.trim();
      if (!name) return alert("Please enter a name.");
      const qs = selectNextQs.value;
      const { error } = await supabase.from("iterations").insert({ name, question_set: qs });
      if (error) alert("Error creating iteration: " + error.message);
      inputNextName.value = "";
      await refresh();
    });

    btnCreateNext.addEventListener("click", async () => {
      const active = iterations.find(it => it.end_date === null);
      if (active) return alert("Close the active iteration first.");
      const closed = iterations.filter(it => it.end_date !== null)
                               .sort((a,b) => new Date(b.end_date) - new Date(a.end_date));
      if (!closed.length) return alert("No closed iteration to clone from.");
      const name = inputNextName.value.trim();
      if (!name) return alert("Enter name for new iteration.");
      const qs = selectNextQs.value;
      try {
        await createNextIterationClone({ sourceIterationId: closed[0].id, newName: name, questionSet: qs });
        inputNextName.value = "";
        await refresh();
      } catch (e) { alert("Clone failed: " + e.message); }
    });

    async function createNextIterationClone({ sourceIterationId, newName, questionSet }) {
      const { data: newIter, error: insErr } = await supabase
        .from("iterations")
        .insert({ name: newName, question_set: questionSet })
        .select().single();
      if (insErr || !newIter) throw new Error(insErr?.message || "Could not insert new iteration");

      const { data: oldUnits, error: unitsErr } = await supabase
        .from("organization_units")
        .select("*")
        .eq("iteration_id", sourceIterationId);
      if (unitsErr) throw new Error(unitsErr.message);

      const childrenByParent = new Map();
      oldUnits.forEach(u => {
        const key = u.parent_id ?? "ROOT";
        if (!childrenByParent.has(key)) childrenByParent.set(key, []);
        childrenByParent.get(key).push(u);
      });
      const idMap = new Map();
      async function cloneLevel(parentOldId, parentNewId) {
        const list = childrenByParent.get(parentOldId ?? "ROOT") || [];
        for (const u of list) {
          const { data: ins, error } = await supabase
            .from("organization_units")
            .insert({ name: u.name, parent_id: parentNewId, iteration_id: newIter.id })
            .select().single();
          if (error) throw new Error(error.message);
          idMap.set(u.id, ins.id);
          await cloneLevel(u.id, ins.id);
        }
      }
      await cloneLevel(null, null);

      const { data: oldRoles, error: rolesErr } = await supabase
        .from("person_roles")
        .select("*")
        .eq("iteration_id", sourceIterationId);
      if (rolesErr) throw new Error(rolesErr.message);

      const newRolesPayload = [];
      oldRoles.forEach(r => {
        const mappedUnitId = idMap.get(r.org_unit_id);
        if (!mappedUnitId) return;
        newRolesPayload.push({
          person_id: r.person_id,
          org_unit_id: mappedUnitId,
          is_manager: r.is_manager,
          description: r.description ?? null,
          iteration_id: newIter.id
        });
      });
      while (newRolesPayload.length) {
        const chunk = newRolesPayload.splice(0, 100);
        const { error } = await supabase.from("person_roles").insert(chunk);
        if (error) throw new Error(error.message);
      }
    }
  </script>
</body>
</html>

